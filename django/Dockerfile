FROM python:3.6

RUN apt-get update && apt-get install -y --no-install-recommends \
	ghostscript \
	postgresql-client \
&& rm -rf /var/lib/apt/lists/* \
&& mkdir /app

WORKDIR /app

ENV DJANGO_SETTINGS_MODULE camac.settings
ENV UWSGI_INI /app/uwsgi.ini
ENV DJANGO_DATABASE_PORT 5432

COPY requirements.txt /app

RUN pip install --no-cache-dir --upgrade -r requirements.txt --disable-pip-version-check

COPY . /app

EXPOSE 80

CMD /bin/sh -c "./wait-for-it.sh $DJANGO_DATABASE_HOST:$DJANGO_DATABASE_PORT -- ./manage.py migrate && ./manage.py loadconfig && uwsgi"
