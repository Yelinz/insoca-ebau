FROM python:3.7

RUN apt-get update && apt-get install -y --no-install-recommends \
	ghostscript \
	postgresql-client \
	gettext \
	locales \
&& rm -rf /var/lib/apt/lists/* \
&& mkdir /app \
&& sed -i -e 's/# de_CH.UTF-8 UTF-8/de_CH.UTF-8 UTF-8/' /etc/locale.gen \
&& dpkg-reconfigure --frontend=noninteractive locales \
&& update-locale LANG=de_CH.UTF-8

WORKDIR /app

ENV DJANGO_SETTINGS_MODULE camac.settings
ENV UWSGI_INI /app/uwsgi.ini
ENV DJANGO_DATABASE_PORT 5432

ARG REQUIREMENTS=requirements.txt
COPY requirements.txt requirements-dev.txt /app/

RUN pip install --no-cache-dir --upgrade -r $REQUIREMENTS  --disable-pip-version-check

COPY . /app

EXPOSE 80

CMD /bin/sh -c "./wait-for-it.sh $DJANGO_DATABASE_HOST:$DJANGO_DATABASE_PORT -- ./manage.py migrate && ./manage.py loadconfig && uwsgi"
