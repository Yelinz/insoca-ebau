<Notifications />

<h3 class="hide-be">
  {{t "workItems.edit"}}
</h3>

<h2 class="hide-sz">
  {{@model.name}}
</h2>
<h4 class="hide-be">
  {{@model.name}}
</h4>

<i>
  {{if @model.description @model.description "-"}}
</i>

<div class="work-item-attributes">
  <div class="work-item-attribute">
    <span class="work-item-attribute__title">
      {{t "workItems.responsible"}}
    </span>
    {{#each @model.addressedServices as |service|}}
      {{service.name}}
    {{else}}
      -
    {{/each}}
  </div>
  <div class="work-item-attribute">
    <span class="work-item-attribute__title">
      {{t "workItems.deadline"}}
    </span>
    {{
      format-date
      @model.deadline
      day="2-digit"
      month="2-digit"
      year="numeric"
      hour="2-digit"
      minute="2-digit"
      hour12=false
    }}
  </div>
  <div class="work-item-attribute">
    <span class="work-item-attribute__title">
      {{t "workItems.createdBy"}}
    </span>
    {{if @model.createdByUser @model.createdByUser.fullName "-"}}
  </div>
  <div class="work-item-attribute">
    <span class="work-item-attribute__title">
      {{t "workItems.createdAt"}}
    </span>
    {{
      format-date
      @model.createdAt
      day="2-digit"
      month="2-digit"
      year="numeric"
      hour="2-digit"
      minute="2-digit"
      hour12=false
    }}
  </div>
  {{#if this.isWorkItemCompleted}}
    <div class="work-item-attribute">
      <span class="work-item-attribute__title">
        {{t "workItems.closedBy"}}
      </span>
      {{@model.closedByUser.fullName}}
    </div>
    <div class="work-item-attribute">
      <span class="work-item-attribute__title">
        {{t "workItems.closedAt"}}
      </span>
      {{
        format-date
        @model.closedAt
        day="2-digit"
        month="2-digit"
        year="numeric"
        hour="2-digit"
        minute="2-digit"
        hour12=false
      }}
    </div>
    <div class="work-item-attribute">
      <span class="work-item-attribute__title">
        {{t "workItems.comment"}}
      </span>
      {{if @model.meta.completion-comment @model.meta.completion-comment "-"}}
    </div>
  {{/if}}
</div>

{{#unless this.isWorkItemCompleted}}
  {{#if (and this.isManualWorkItem this.isCreator)}}
    <form
      class="form form-edit work-item-form"
      {{on "submit" (perform this.saveManualWorkItem)}}
    >
      <fieldset>
        <legend class="hide-sz">
          {{t "workItems.actions.edit"}}
        </legend>

        <div class="row first">
          <div class="label">
            <label for="description">
              {{t "workItems.description"}}
            </label>
          </div>
          <div class="column-2">
            <Textarea id="description" @value={{@model.description}} />
          </div>
        </div>

        <div class="row">
          <div class="label">
            <label for="deadline">
              {{t "workItems.deadline"}}
              <span class="mandatory">
                *
              </span>
            </label>
          </div>
          <div class="column-2">
            <PikadayInput
              id="deadline"
              @value={{@model.deadline}}
              @useUTC={{true}}
              @onSelection={{this.setDeadline}}
            />
          </div>
        </div>

        <div class="row">
          <div class="label">
            <label>
              {{t "workItems.notifications"}}
            </label>
          </div>
          <div class="column-2">
            <label class="checkbox-label">
              <Input
                @type="checkbox"
                @checked={{mut @model.meta.notify-completed}}
              />
              {{t "workItems.notifyCompleted"}}
            </label>
            <br />
            <label class="checkbox-label">
              <Input
                @type="checkbox"
                @checked={{mut @model.meta.notify-deadline}}
              />
              {{t "workItems.notifyDeadline"}}
            </label>
          </div>
        </div>
      </fieldset>

      <div class="row buttons-container">
        <button class="button buttonstyle btn success" type="submit">
          {{t "global.save"}}
        </button>
      </div>
    </form>
  {{else if this.model.isAddressed}}
    <form
      class="form form-edit work-item-form"
      {{did-insert (perform this.fetchUserChoices)}}
      {{on "submit" (perform this.workItemAssignUsers)}}
    >
      <fieldset>
        <div class="row">
          <div class="label">
            <label>
              {{t "workItems.assignedUser"}}
              <span class="mandatory">
                *
              </span>
            </label>
          </div>
          <div class="column-2">
            <PowerSelect
              @searchEnabled={{true}}
              @searchField="fullName"
              @renderInPlace={{true}}
              @options={{this.userChoices}}
              @selected={{this.responsibleUser}}
              @noMatchesMessage={{t "global.noMatch"}}
              @onChange={{fn (mut this.responsibleUser)}} as |responsibleUser|
            >
              {{responsibleUser.fullName}}
            </PowerSelect>
          </div>
        </div>
      </fieldset>

      <div class="row buttons-container">
        <button class="button buttonstyle btn success" type="submit">
          {{t "global.save"}}
        </button>
      </div>
    </form>
  {{/if}}
{{/unless}}

{{#if
  (and
    (not this.isWorkItemCompleted) this.isManualWorkItem this.model.isAddressed
  )
}}
  <h3 class="hide-be">
    {{t "workItems.actions.finish"}}
  </h3>

  <form
    class="form form-edit work-item-form"
    {{on "submit" (perform this.finishWorkItem)}}
  >
    <fieldset>
      <legend class="hide-sz">
        {{t "workItems.actions.finish"}}
      </legend>

      <div class="row first">
        <div class="label">
          <label>
            {{t "workItems.comment"}}
          </label>
        </div>
        <div class="column-2">
          <Textarea @value={{@model.meta.completion-comment}} />
        </div>
      </div>
    </fieldset>

    <div class="row buttons-container">
      <button class="button buttonstyle btn success" type="submit">
        {{t "workItems.actions.finish"}}
      </button>
    </div>
  </form>
{{/if}}