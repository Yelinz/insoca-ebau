version: "3.4"
services:
    cache:
        image: memcached:1.5-alpine

    proxy:
        image: nginx:1.13-alpine
        depends_on:
            - caluma
            - ember
            - php
            - django
            - keycloak
            - mailcatcher
        volumes:
            - djangomedia:/var/lib/camac/media:ro

    db:
        build:
            context: db
            cache_from:
                - acr.run/camac-ng/camac-ng/db:master
        environment:
            - POSTGRES_USER=camac
            - POSTGRES_DATABASE=${APPLICATION}
        volumes:
            - pgdata:/var/lib/postgresql/data

    caluma:
        image: acr.run/camac-ng/camac-ng/caluma:${CI_COMMIT_REF_SLUG:-master}
        build:
            context: caluma
            cache_from:
                - acr.run/camac-ng/camac-ng/caluma:master
        environment:
            - DATABASE_HOST=db
            - DATABASE_PORT=5432
            - DATABASE_NAME=caluma
            - DATABASE_PASSWORD=camac
            - DATABASE_USER=camac
            - ENV=development
            - OIDC_USERINFO_ENDPOINT=http://camac-ng-keycloak.local/auth/realms/ebau/protocol/openid-connect/userinfo
        volumes:
            - ./caluma/extensions:/app/caluma/extensions:ro
            - ./caluma/fixtures:/app/caluma/fixtures:ro
        command: /bin/sh -c "wait-for-it.sh db:5432 -- ./manage.py migrate && ./manage.py runserver 0.0.0.0:8000"
        depends_on:
            - php
            - db

    django:
        build:
            context: django
            cache_from:
                - acr.run/camac-ng/camac-ng/django:master
        depends_on:
            - db
            - cache
            - clamav
            - keycloak
            - mailcatcher
            - unoconv
        environment:
            - DJANGO_DATABASE_HOST=db
            - DJANGO_DATABASE_NAME=${APPLICATION}
            - DJANGO_CACHE_LOCATION=cache:11211
            - DJANGO_MEDIA_ROOT=/var/lib/camac/media
            - DJANGO_UNOCONV_URL=http://unoconv:3000
            - DJANGO_CLAMD_TCP_ADDR=clamav
            - APPLICATION=${APPLICATION}
        volumes:
            - djangomedia:/var/lib/camac/media

    ember:
        build:
            context: ember
            cache_from:
                - acr.run/camac-ng/camac-ng/ember:master
        depends_on:
            - django
        environment:
            - ENV=docker

    ember-caluma-portal:
        build:
            context: ember-caluma-portal
            cache_from:
                - acr.run/camac-ng/camac-ng/ember-caluma-portal:master
        depends_on:
            - django
            - caluma
        environment:
            - ENV=docker

    php:
        build:
            context: php
            cache_from:
                - acr.run/camac-ng/camac-ng/php:master
        depends_on:
            - db
            - django
            - cache
            - keycloak
            - mailcatcher
        environment:
            - APPLICATION=${APPLICATION}
        volumes:
            - djangomedia:/var/www/camac/media
            - phpsessions:/var/www/camac/sessions
            - /var/www/camac/vendor
            - /var/www/camac/public/public-kt_bern/css
            - /var/www/camac/public/public-kt_bern/js
            - /var/www/camac/public/node_modules
            - /var/www/camac/public/bower_components

    mailcatcher:
        image: schickling/mailcatcher

    unoconv:
        image: zrrrzzt/docker-unoconv-webservice:8.9.4

    clamav:
        image: dinkel/clamavd

    keycloak:
        depends_on:
            - db
        image: acr.run/camac-ng/keycloak:3.4.3.Final_theme-v0.2.0-SNAPSHOT
        environment:
            - POSTGRES_PORT_5432_TCP_ADDR=db
            - POSTGRES_USER=camac
            - POSTGRES_DATABASE=${APPLICATION}
            - KEYCLOAK_USER=admin

    document-merge-service:
        image: adfinissygroup/document-merge-service
        depends_on:
            - db
            - unoconv
        volumes:
            - ./document-merge-service/uwsgi.ini:/app/uwsgi.ini:ro
            - ./document-merge-service/templatefiles:/var/lib/document-merge-service/media
            - ./document-merge-service/dump.json:/tmp/document-merge-service/dump.json
        environment:
            - DATABASE_ENGINE=django.db.backends.postgresql
            - DATABASE_HOST=db
            - DATABASE_NAME=kt_bern
            - DATABASE_USER=camac
            - DATABASE_PASSWORD=camac
            - UNOCONV_URL=http://unoconv:3000
            - REQUIRE_AUTHENTICATION=True
            - GROUP_ACCESS_ONLY=True
            - OIDC_USERINFO_ENDPOINT=http://camac-ng-keycloak.local/auth/realms/ebau/protocol/openid-connect/userinfo
            - OIDC_BEARER_TOKEN_REVALIDATION_TIME=5
            - OIDC_GROUPS_API=http://camac-ng.local/api/v1/me
            - OIDC_GROUPS_API_JSONPATH=$$.data.relationships.service.data.id
            - OIDC_GROUPS_API_HEADERS=AUTHORIZATION,X-CAMAC-GROUP


volumes:
    pgdata:
    djangomedia:
    phpsessions:
    templatefiles:
