version: "3.4"
services:
  proxy:
    image: nginx:1.13-alpine
    depends_on:
      - ember
      - ember-camac-ng
      - php
      - django
      - keycloak
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /etc/certbot:/etc/certbot:ro
      - /srv/www/htdocs:/var/www/letsencrypt:ro
      - /etc/camac/nginx:/etc/nginx/conf.d:ro
      - djangomedia:/var/lib/camac/media:ro
      - djangotmpmedia:/tmp/camac/tmpfiles:ro

  django:
    image: acr.run/camac-ng/camac-ng/django:${CI_COMMIT_REF_SLUG}-${APPLICATION}
    build:
      context: ../django
      cache_from:
        - acr.run/camac-ng/camac-ng/django:${CI_COMMIT_REF_SLUG}-${APPLICATION}
    depends_on:
      - cache
      - clamav
      - keycloak
      - unoconv
      - postfix
    restart: always
    environment:
      - DATABASE_HOST=vm-kantonsz-db-vip.cust.adfinis-sygroup.ch
      - DJANGO_ENV_FILE=/run/secrets/django.env
      - DJANGO_MERGE_DATE_FORMAT=%-d. %B %Y
    volumes:
      - /etc/camac/django.env:/run/secrets/django.env:ro
      - djangomedia:/var/lib/camac/media
      - djangotmpmedia:/tmp/camac/tmpfiles

  ember:
    image: acr.run/camac-ng/camac-ng/ember:${CI_COMMIT_REF_SLUG}-${APPLICATION}
    build:
      context: ../ember
      cache_from:
        - acr.run/camac-ng/camac-ng/ember:${CI_COMMIT_REF_SLUG}-${APPLICATION}
      args:
        KEYCLOAK_URL_ARG: ${KEYCLOAK_URL}
        DEPLOY_TARGET: production
    depends_on:
      - django
    restart: always

  ember-camac-ng:
    image: acr.run/camac-ng/camac-ng/ember-camac-ng:${CI_COMMIT_REF_SLUG}-${APPLICATION}
    build:
      context: ../
      dockerfile: ./ember-camac-ng/Dockerfile
      cache_from:
        - acr.run/camac-ng/camac-ng/ember-camac-ng:${CI_COMMIT_REF_SLUG}-${APPLICATION}
      args:
        - APPLICATION=${APPLICATION}
    restart: always

  php:
    image: acr.run/camac-ng/camac-ng/php:${CI_COMMIT_REF_SLUG}-${APPLICATION}
    build:
      context: ../php
      cache_from:
        - acr.run/camac-ng/camac-ng/php:${CI_COMMIT_REF_SLUG}-${APPLICATION}
    depends_on:
      - django
      - cache
      - keycloak
    restart: always
    environment:
      - APPLICATION=${APPLICATION}
      - APPLICATION_ENV=production
    volumes:
      - djangomedia:/var/www/camac/media
      - phpsessions:/var/www/camac/sessions
      - /etc/camac/php.ini:/usr/local/etc/php/php.ini:ro
      - /etc/camac/application.ini:/var/www/camac/${APPLICATION}/configs/application.local.ini:ro
      # TODO: Implement resource fallback in document module, so this can be removed
      - phpresources:/var/www/camac/kt_uri/resources

  cache:
    image: memcached:1.5-alpine
    restart: always

  unoconv:
    image: zrrrzzt/docker-unoconv-webservice:8.9.4
    restart: always

  clamav:
    image: tiredofit/clamav:2.3.0
    restart: always

  keycloak:
    image: acr.run/camac-ng/keycloak:3.4.3.Final_theme-v0.2.0-SNAPSHOT
    volumes:
      - /etc/camac/keycloak.env:/run/secrets/keycloak.env:ro
    environment:
      - ENV_FILE=/run/secrets/keycloak.env
    restart: always

  postfix:
    image: mwader/postfix-relay
    restart: always
    environment:
      - POSTFIX_myhostname=ebau-sz.ch
      - POSTFIX_mail_name=noreply@ebau-sz.ch

  metabase:
    image: metabase/metabase:v0.35.4
    ports:
      - "666:3000"
    environment:
      - MB_DB_TYPE=postgres
      - MB_DB_DBNAME=metabase
      - MB_DB_PORT=5432
      - MB_DB_USER=metabase
      - MB_DB_PASS=${METABASE_DB_PASS_PROD}
      - MB_DB_HOST=vm-kantonsz-db-vip.cust.adfinis-sygroup.ch
    restart: always

volumes:
  djangomedia:
    external:
      name: camacdjangomedia

  djangotmpmedia:
    external:
      name: camacdjangotmpmedia

  phpsessions:
    external:
      name: camacphpsessions

  phpresources:
    external:
      name: camacphpresources
